<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>尽管扯淡-回溯算法Ruby实现</title>
    <meta name="description" content="资深码农，程序设计语言控">
    <link rel="canonical" href="https://jameszhan.github.io/2011/02/14/backtracing-ruby.html">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/assets/stylesheets/main.css">
</head>


<body>

<header class="navbar navbar-inverse navbar-fixed-top" role="banner" data-include="/assets/tpls/header.tpl"></header>

<div class="container">
    <div class="col-md-9">
    <div class="post">

        <header class="post-header">
            <h1 class="post-title">回溯算法Ruby实现</h1>
            <p class="post-meta">
                2011年02月14日 •
                詹子知(James Zhan) •
                版权所有，转载须声明出处
            </p>
        </header>

        <article class="post-content">
            <h3 id="section">什么是回溯法</h3>
<p>回溯法（探索与回溯法）是一种选优搜索法，又称为试探法，按选优条件向前搜索，以达到目标。但当探索到某一步时，发现原先选择并不优或达不到目标，就退回一步重新选择，这种走不通就退回再走的技术为回溯法，而满足回溯条件的某个状态的点称为“回溯点”。</p>

<p>包含问题的所有解的解空间树中，按照深度优先搜索的策略，从根结点出发深度探索解空间树。当探索到某一结点时，要先判断该结点是否包含问题的解，如果包含，就从该结点出发继续探索下去，如果该结点不包含问题的解，则逐层向其祖先结点回溯。（其实回溯法就是对隐式图的深度优先搜索算法）。 若用回溯法求问题的所有解时，要回溯到根，且根结点的所有可行的子树都要已被搜索遍才结束。 而若使用回溯法求任一个解时，只要搜索到问题的一个解就可以结束。</p>

<h3 id="section-1">算法实现</h3>

<h4 id="section-2">算法准备</h4>

<p>准备一个默认的打印函数，把数组a中的数组转换成字母打印出来。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">ALPHABET</span> <span class="o">=</span> <span class="no">Array</span><span class="p">(</span><span class="s1">'A'</span><span class="p">.</span><span class="nf">.</span><span class="s1">'Z'</span><span class="p">)</span>                       
<span class="no">DISPLAY</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="nb">p</span> <span class="n">a</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="no">ALPHABET</span><span class="p">[</span><span class="n">i</span><span class="p">]}}</span>   
</code></pre>
</div>

<p>实现方式，在这里，我们设计回溯法的实现需要接受是个参数，分别是n, m, handle，以及block。</p>

<ol>
  <li>n, m决定我们搜索的解空间大小，比如，给定6， 3， 则整个解空间范围为111, 112, …, 666（约定默认计数从1开始），整个解空间大小为6^3 = 216。</li>
  <li>handle一般用于打印结果。</li>
  <li>block则是我们要选择的约束函数。对于执行过程中某一个特定位置，如果当前的值满足要求，则继续找下一个位置的值，否则，把当前值加1，如果加1以后的结果超过n的值，则退回到上一位置，并把上一位置的值加1，继续往后查找。</li>
</ol>

<h4 id="section-3">递归版本</h4>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">backtrack</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">handle</span> <span class="o">=</span> <span class="no">DISPLAY</span><span class="p">)</span> 
  <span class="n">dfs</span> <span class="o">=</span> <span class="nb">lambda</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span>              
    <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">n</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>               
      <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>                        
      <span class="k">if</span> <span class="k">yield</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>                  
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span>                 
          <span class="n">handle</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>              
        <span class="k">else</span>                          
          <span class="n">dfs</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>          
        <span class="k">end</span>                           
      <span class="k">end</span>                             
    <span class="k">end</span>                               
  <span class="p">}</span>                                   
  <span class="n">a</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>                
  <span class="n">dfs</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>                      
<span class="k">end</span>                                   
</code></pre>
</div>

<h4 id="section-4">非递归版本实现</h4>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">backtrack</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">handle</span> <span class="o">=</span> <span class="no">DISPLAY</span><span class="p">)</span>  
  <span class="n">k</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>           
  <span class="k">while</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span>                         
    <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>                          
    <span class="k">while</span> <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">yield</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>     
      <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>                        
    <span class="k">end</span>                                
    <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span> <span class="o">||</span> <span class="n">k</span> <span class="o">==</span> <span class="n">m</span>             
      <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span>                           
    <span class="k">else</span>                               
      <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span>                    
        <span class="n">handle</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>                 
      <span class="k">else</span>                             
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>                         
        <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>                      
      <span class="k">end</span>                              
    <span class="k">end</span>                                
  <span class="k">end</span>                                  
<span class="k">end</span>                                    
</code></pre>
</div>

<h4 id="section-5">使用回溯法实现其他算法</h4>

<ol>
  <li>列出全部解空间</li>
</ol>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)</span>             
  <span class="n">handle</span> <span class="o">=</span> <span class="no">DISPLAY</span> <span class="k">unless</span> <span class="n">handle</span>       
  <span class="n">backtrace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span>    
    <span class="kp">true</span>                               
  <span class="k">end</span>                                  
<span class="k">end</span>                                    
</code></pre>
</div>

<ol>
  <li>实现排列算法</li>
</ol>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">permutation</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)</span>                       
  <span class="n">handle</span> <span class="o">=</span> <span class="no">DISPLAY</span> <span class="k">unless</span> <span class="n">handle</span>                     
  <span class="n">backtrack</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span>                  
    <span class="n">succ</span> <span class="o">=</span> <span class="kp">true</span>                                      
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">k</span><span class="p">)</span> <span class="k">do</span>                              
     <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>                                 
       <span class="n">succ</span> <span class="o">=</span> <span class="kp">false</span>                                  
       <span class="k">break</span>                                         
     <span class="k">end</span>                                             
    <span class="k">end</span>                                              
    <span class="n">succ</span>                                             
  <span class="k">end</span>                                                
<span class="k">end</span>
</code></pre>
</div>

<ol>
  <li>实现组合算法</li>
</ol>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">combination</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)</span>                       
  <span class="n">handle</span> <span class="o">=</span> <span class="no">DISPLAY</span> <span class="k">unless</span> <span class="n">handle</span>                     
  <span class="n">backtrace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span>                  
    <span class="n">succ</span> <span class="o">=</span> <span class="kp">true</span>                                      
    <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">k</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>                              
      <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>                                
        <span class="n">succ</span> <span class="o">=</span> <span class="kp">false</span>                                 
        <span class="k">break</span>                                        
      <span class="k">end</span>                                            
    <span class="k">end</span>                                              
    <span class="n">succ</span>                                             
  <span class="k">end</span>                                                
<span class="k">end</span>                                                  
</code></pre>
</div>

<ol>
  <li>解决n皇后问题</li>
</ol>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">nqueen</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)</span>                               
  <span class="n">backtrace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span>                  
    <span class="n">succ</span> <span class="o">=</span> <span class="kp">true</span>                                      
    <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">k</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>                              
      <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">abs</span> <span class="o">==</span> <span class="n">k</span> <span class="o">-</span> <span class="n">i</span>  
        <span class="n">succ</span> <span class="o">=</span> <span class="kp">false</span>                                 
        <span class="k">break</span>                                        
      <span class="k">end</span>                                            
    <span class="k">end</span>                                              
    <span class="n">succ</span>                                             
  <span class="k">end</span>                                                
<span class="k">end</span>                                                  
</code></pre>
</div>

<p>事实上，回溯法能解决的算法问题远不仅于此，回溯法本质上是穷举法的一种，只要解包含特征：后一个位置的选择依赖于前面的选择状态，我们便可以使用回溯法来实现。尽管回溯法的时间复杂度为n^m，但是由于在搜索解空间树的过程中，很多分支在一早就被剪去了，所以在实际应用过程中，其往往十分高效。</p>

<h4 id="section-6">实例演示</h4>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="kp">__FILE__</span> <span class="o">==</span> <span class="vg">$0</span>   
    <span class="nb">puts</span> <span class="s1">'counter =&gt;'</span>                              
    <span class="n">counter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>                                  
                                                   
    <span class="nb">puts</span> <span class="s1">'permutation =&gt;'</span>                          
    <span class="n">permutation</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">){</span><span class="o">|</span><span class="n">a</span><span class="o">|</span><span class="nb">p</span> <span class="n">a</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}}</span>       
                                                   
    <span class="nb">puts</span> <span class="s1">'combination =&gt;'</span>                          
    <span class="n">combination</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span><span class="o">|</span><span class="n">a</span><span class="o">|</span><span class="nb">p</span> <span class="n">a</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}}</span>       
                                                   
    <span class="nb">puts</span> <span class="s1">'nqueue =&gt; '</span>                              
    <span class="n">nqueen</span><span class="p">(</span><span class="mi">5</span><span class="p">){</span><span class="o">|</span><span class="n">a</span><span class="o">|</span><span class="nb">p</span> <span class="n">a</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}}</span>   
<span class="k">end</span>                                                
</code></pre>
</div>

<p><a href="https://github.com/jameszhan/rhea/blob/master/codes/ruby/algorithm/backtracking.rb">查看完整代码</a>。</p>


        </article>

        <div class="row-fluid">
            <ul class="list-inline">
                <li><i class="glyphicon glyphicon-folder-open"></i></li>
                
                
    
    <li class="tag"><a href="/categories/algorithm.html">Algorithm<span>5</span></a></li>
    

            </ul>
            <ul class="list-inline">
                <li><i class="glyphicon glyphicon-tags"></i></li>
                
                
    
    <li class="tag"><a href="/tags/algorithm.html">Algorithm<span>5</span></a></li>
    

    
    <li class="tag"><a href="/tags/ruby.html">Ruby<span>5</span></a></li>
    

    
    <li class="tag"><a href="/tags/backtracking.html">Backtracking<span>3</span></a></li>
    

            </ul>
        </div>

        <div class="row-fluid">
            <ul class="pagination pull-right">
                
                <li class="prev"><a href="/2010/01/01/backtracking-python.html" title="回溯算法Python实现">&larr; 上一篇</a></li>
                
                <li><a href="https://jameszhan.github.io">Archive</a></li>
                
                <li class="next"><a href="/2013/03/13/setup-ubuntu-automatically.html" title="自动配置Ubuntu开发环境">下一篇 &rarr;</a>
                </li>
                
            </ul>
        </div>
    </div>

    <!-- 多说评论框 start -->
<div class="ds-thread"
     data-thread-key="/2011/02/14/backtracing-ruby.html"
     data-title="回溯算法Ruby实现"
     data-url="https://jameszhan.github.io/2011/02/14/backtracing-ruby.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    var duoshuoQuery = {short_name:"jameszhan"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();

    $(document).on('click', '#ds-thread textarea[name=message]', function(){
        $('#ds-sync-checkbox').prop('checked', false);
    });
</script>
<!-- 多说公共JS代码 end -->



    <!--<div data-include="/assets/tpls/widgets/comments.tpl"></div>-->
</div>

<div class="col-md-3">
    <div data-include="/assets/tpls/widgets/tags.tpl"></div>
<div data-include="/assets/tpls/widgets/categories.tpl"></div>

</div>


</div>

<div class="container" data-include="/assets/tpls/footer.tpl"></div>

<div class="modal fade" id="globalModal" tabindex="-1" role="dialog" aria-labelledby="globalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
        </div>
    </div>
</div>

<script type="text/javascript" src="/assets/javascripts/seajs/sea.js"></script>
<script type="text/javascript" src="/assets/javascripts/firing.js"></script>
<div class="analytics">
    <script type="text/javascript" src="/assets/javascripts/analytics.js"></script>
</div>
</body>
</html>